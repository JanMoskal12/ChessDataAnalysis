---
title: "ChessDataAnalysyis"
author: "Jan Moskal"
format: html
editor: visual
---

```{r, include=FALSE, message=FALSE, warning=FALSE}
library(tidyverse)
library(networkD3)
library(plotly)
library(gganimate)
```

```{r, include=FALSE}
data <- readRDS("cleaned_data.rds")


View(data)
glimpse(data)
```

### Variant:

Przyglądam się tutaj, niewielkiej liczbie gier, które rozpoczynają się z pewnej ustalonej przez graczy pozycji

```{r}
data %>% 
  count(variant)

data %>% 
  filter(variant == "fromPosition") %>% 
  count(players_white_user_name, sort = TRUE) %>% 
  head(n = 1) %>%  select(players_white_user_name)
```

Nie ma tutaj jednak nic ciekawego, za sporą liczbę meczy (9/27) odpowiada jeden gracz 'Monkey King'

### Speed:

Przyglądam się tutaj, jak dzielą się wygrane i przegrane dla formatów czasowych

```{r}

data %>%  
  ggplot(aes(x = factor(speed, levels = c("ultraBullet", "bullet", "blitz", "rapid","classical")), fill = winner)) +
  geom_bar(position = "fill") +
  labs(x = NULL, y = "Stosunek wygranych,przegranych i zremisowanych meczy", fill = "Zwycięzca", 
       title = "Dystrybucja zwycięstw dla poszczególnych formatów czasowych") +
  scale_fill_manual(values = c("black" ="black", "draw" = "grey", "white" = "white")) +
  theme(panel.background = element_rect(fill = "lightgrey"),
        legend.background = element_rect(fill = "lightblue"),
        plot.background = element_rect(fill = "lightgrey")) 

  
```

Jak widać wraz z większą ilością czasu gry rośnie liczba remisów. Jest to jaknajbardziej logiczne, gracze mają więcej czasu na analizę, planowanie i liczenie wariantów, po obu stronach popełniają mniej poważnych błędów przez co partia jest bardziej wyrównana. Widać również, że wygrane graczy z białymi i czarnymi figurami są na podobnym poziomie, to zjawisko wynika z charakterystyki analizowanego zestawu danych. Mamy tutaj do czynienia z najlepszymi graczami w konkretnych formatach czasowych na Lichess. Silniejsi i bardziej doświadczeni gracze są w stanie efektywnie korzytsać z obu stron planszy, co prowadzi do równomiernej dystrybucji zwycięstw.

Dla kontrastu dane dotyczące przeciętnych graczy Lichessa:

Sprawdzam czy któreś otwarcia pojawiają się częściej w poszczególnych formatach czasowych

```{r}
data %>% group_by(opening_name) %>% count(sort = TRUE) #defensywne, w top 10 tylko dwa otwarcia 1.e4 tylko dwa mecze na 20000 z King's Knight Opening

ubu_opening <- data %>% filter(speed == "ultraBullet") %>% 
  group_by(opening_name) %>%  count(sort = TRUE)  # defensywne i elastyczne, "krótkie" ruchy bardzo popularne

bu_opening <- data %>% filter(speed == "bullet") %>% 
  group_by(opening_name) %>%  count(sort = TRUE) #elastyczne trochę więcej ruchów z 1.e4, dużo większa liczba unikalnych otwarć

bl_opening <- data %>% filter(speed == "blitz") %>% 
  group_by(opening_name) %>%  count(sort = TRUE) # mniej defensywnie, obrona sycylisjka (więcej 1.e4)

ra_opening <- data %>% filter(speed == "rapid") %>% 
  group_by(opening_name) %>%  count(sort = TRUE) # solidne, bardziej agresywne otwarcia sporo 1.e4 caro-kann

cl_opening <- data %>% filter(speed == "classical") %>% 
  group_by(opening_name) %>%  count(sort = TRUE) # solidne, więcej 1.e4

print(c(nrow(ubu_opening), nrow(bu_opening), nrow(bl_opening), nrow(ra_opening), nrow(cl_opening)))
```

Liczba unikalnych otwarć wzrasta wraz z długością gry. W skrócie, w miarę wydłużania się czasu na partię, gracze są bardziej skłonni eksperymentować z różnymi otwarciami, a strategie stają się bardziej zróżnicowane. W szybszych formatach często dominują ruchy elastyczne, a w dłuższych partach pojawiają się bardziej solidne i strategiczne otwarcia.

Jak wygląda dystrybucja tytułów graczy w zależności od formatu czasowego?

```{r}
w_players <- data %>%
  select(speed, players_white_user_name, players_white_user_title) %>%
  rename(player = players_white_user_name, 
         title = players_white_user_title)
b_players <- data %>%
  select(speed, players_black_user_name, players_black_user_title) %>% 
    rename(player = players_black_user_name, 
         title = players_black_user_title)


players_titles <- rbind(w_players, b_players) %>% distinct(player, speed, .keep_all = TRUE) # Wszyscy gracze z bazy z ich tytułami (liczeni kilukrotnie po formacie czasowym)

most_comon_titles <- data %>% 
  group_by(players_white_user_title) %>% 
  count(sort = TRUE) %>%  filter(n > 10)

players_titles %>% 
  filter(title %in% most_comon_titles$players_white_user_title) %>% 
  ggplot(aes(x = fct_infreq(speed), fill = title)) +
  geom_bar()


players_titles %>% 
  filter(title %in% most_comon_titles$players_white_user_title) %>% 
  ggplot(aes(x = fct_infreq(speed), fill = title)) +
  geom_bar(position = "fill")
```

Taki rozkład graczy tytulowanych dla każdego formatu czasowego jest z pewnością związany z umiejętnościami i doświadczeniem graczy.Silni gracze mogą być bardziej skłonni do wybierania szybszych partii, podczas gdy gracze bez tytułów mogą preferować dłuższe partie, gdzie mają więcej czasu na analizę i naukę. To zjawisko może wpływać na obserwowaną dystrybucję tytułów w różnych formatach czasowych. Te dwa wykresy ukazują wiele rzeczy, część może wydawać się nieintuicyjna np. w drugim wykresie stosunek graczy bez tytułu do wszystkich graczy spada wraz ze spadkiem długości meczu, jednak nie dla ultraBulleta, dlaczego Moje hipoteza to możliwość unikania ultraBulleta przez graczy tytułowanych, ponieważ preferują bardziej zaawansowane i strategiczne gry, gdzie ich umiejętności są lepiej wykorzystywane. UltraBullet, charakteryzujący się szybkimi ruchami i chaotyczną rozgrywką, przyciąga różnorodne grupy graczy, a dominacja graczy bez tytułów może wynikać z bardziej rekreacyjnego podejścia do tej formy rozgrywki. Na wykresie pierwszym w oczy rzuca się jeszcze jedna rzecz to znaczy: im krótszy format czasowy tym mniejsza różnorodność graczy. To może mieć powiązanie z tym co piałem wcześniej, wielu graczy nietytułowanych próbuje swoich sił w szachach klasycznych, dlatego jest ich tak dużo, za to w szachach szybkich i blyskawicznych rządzą mocni gracze tytułowani i nie ma aż tak dużo graczy nietytułowanych (wciąż bardzo dużo)

Jak powiązany jest ranking graczy z ich tytułąmi?

```{r}
w_players_rt <- data %>%
  select(players_white_user_title, players_white_user_name, players_white_rating, speed) %>%
  rename(player = players_white_user_name, 
         title = players_white_user_title,
         rating = players_white_rating)

b_players_rt <- data %>%
  select(players_black_user_title, players_black_user_name, players_black_rating, speed) %>% 
    rename(player = players_black_user_name, 
           title = players_black_user_title,
           rating = players_black_rating)

players_ratings_titles <- rbind(w_players_rt, b_players_rt) %>%
  distinct(player, speed, .keep_all = TRUE)

players_ratings_titles %>% 
  filter(title %in% most_comon_titles$players_white_user_title) %>%
  ggplot(aes(x = reorder(title, -rating), y = rating, fill = reorder(title, -rating))) +
  geom_boxplot() +
  theme_minimal() +
  theme(legend.position = "none") + 
  labs(y = "Ranking gracza", x = "Tytuł gracza") #+
  #facet_wrap(~speed)
```

Nie ma tutaj nic zaskakującego gracze, gracze z najwyższymi tytułami mają najwyższe rankingi

Czy istnieje związek między rankiem graczy a formatem czasowym?

```{r}
w_players_r <- data %>%
  select(speed, players_white_user_name, players_white_rating) %>%
  rename(player = players_white_user_name, 
         rating = players_white_rating)

b_players_r <- data %>%
  select(speed, players_black_user_name, players_black_rating) %>% 
    rename(player = players_black_user_name, 
         rating = players_black_rating)


players_ratings <- rbind(w_players_r, b_players_r) %>% distinct(player, speed, .keep_all = TRUE) # Zamiast usuwać powtarzające się to zamienić na średnią to dać średnią

players_ratings %>% 
  group_by(speed) %>% 
  ggplot(aes(x = rating, color = speed)) +
  geom_freqpoly(linewidth = 2)
```

Tutaj widać, to o czym wcześniej mówiłem to znaczy gracze bez tytułów, wybierają chętniej partie z wiekszą ilością czasu, za to gracze z tytułami te krótsze formaty. Tutaj po rankingach można zobaczyć to samo.

Czy średnia analiza ACPL różni się między konkretnymi formatami czasowymi?

```{r}
w_players_acpl <- data %>%
  select(speed, players_white_user_name, players_white_analysis_acpl) %>%
  rename(player = players_white_user_name, 
         acpl = players_white_analysis_acpl)

b_players_acpl <- data %>%
  select(speed, players_black_user_name, players_black_analysis_acpl) %>% 
    rename(player = players_black_user_name, 
           acpl = players_black_analysis_acpl)

players_acpl <- rbind(w_players_acpl, b_players_acpl) %>% 
  distinct(player, speed, .keep_all = TRUE)


players_acpl %>% 
  ggplot(aes(x = fct_reorder(speed, -acpl), y = acpl, fill = speed)) +
  geom_boxplot() +
  labs(x = NULL, y = "Average Centipawn Loss dla graczy") +
  theme(legend.position = "none")
```

Tak jak można było się spodziewać, w grach z większym ograniczniem czasowym gracze popełniają więcej poważnych błędów

### Status:

Jak będzię wyglądała dystrybucja poszczególnych statusów dla różnych formatów czasowych?

```{r}
data %>% 
  ggplot(aes(x = speed, fill = status)) +
  geom_bar(position = "fill") +
  labs(x = NULL)
```

### Players user provisional:

Czy gracze tymczasowi mają tendencję do częstszego czy rzadszego wygrywania?

```{r}
data %>% 
  ggplot(aes(x = players_white_provisional, fill = winner)) +
  geom_bar(position = "fill")

data %>% 
  ggplot(aes(x = players_black_provisional, fill = winner)) +
  geom_bar(position = "fill")

# Gracze z nowymi kontami mają sporo więcej porażek
```

Czy istnieje związek między graczem tymczasowym, a formatem czasowym?

```{r}
data %>% 
  mutate(provisional = players_white_provisional | players_black_provisional) %>% 
  ggplot(aes(x = fct_infreq(speed, w = as.integer(provisional)), fill = provisional)) +
  geom_bar()
```

### Moves:

Jak wygląda dystrybucja dla pierwszego ruchu w zależności od formatu czasowego?

```{r}
first_move_data <- data %>% 
  mutate(first_move = str_extract(moves, "^\\w+"))
  
top_5_moves <- first_move_data %>% 
  count(first_move, sort = TRUE) %>% 
  head(n = 5) 
  
  first_move_data %>% 
  filter(first_move %in% top_5_moves$first_move) %>% 
  ggplot(aes(x = speed, fill = first_move)) +
  geom_bar(position = "fill")
```

### Duration:

Jaki jest związek między długością gry w sekundach, a ACPL?

```{r}
data %>% 
  mutate(duration_in_seconds = duration_in_miliseconds / 1000) %>% 
  ggplot(aes(y = players_white_analysis_acpl, x = duration_in_seconds)) +
  geom_point(alpha = 0.2, color = "red") +
  geom_smooth() +
  scale_y_continuous(breaks = seq(from = 0, to = 200, by = 20)) +
  ylim(0, 200) +
  xlim(0, 10000) 
```

```{r}
players_titles_connections <- data %>% 
  mutate(winner = case_when(
    winner == "white" ~ 1,
    winner == "black" ~ 0,
    winner == "draw" ~ 0.5)) %>% 
  group_by(players_white_user_title, players_black_user_title) %>% 
  summarise(n = n(),
            mean_white_winner = mean(winner)) %>% 
  filter(n > 100) %>% 
  arrange(mean_white_winner) %>% 
  filter(players_white_user_title == "None" | players_black_user_title == "None")

players_titles_connections$combined_titles <- paste(players_titles_connections$players_white_user_title, 
                                                    players_titles_connections$players_black_user_title,
                                                    sep = "-")

players_titles_connections %>% 
  ggplot(aes(y = fct_reorder(combined_titles, mean_white_winner),
             x = mean_white_winner,
             fill = fct_reorder(combined_titles, mean_white_winner))) +
  geom_bar(stat = "identity") +
  theme(legend.position = "none")


players_titles_connections %>% 
  ggplot(aes(x = players_white_user_title, players_black_user_title, fill = mean_white_winner)) +
  geom_tile()

```


Jakie są najczęstsze połączenia między tytułami?
```{r}
links <- data %>% 
  filter(speed == "bullet") %>% 
  group_by(players_white_user_title, players_black_user_title) %>% 
  summarise(n = n()) %>% 
  filter(n > 50)

links <- as.data.frame(links)
links$players_black_user_title <- paste(links$players_black_user_title, " ", sep="")

nodes <- data.frame(name=c(as.character(links$players_white_user_title), as.character(links$players_black_user_title)) %>% unique())

links$IDsource <- match(links$players_white_user_title, nodes$name)-1 
links$IDtarget <- match(links$players_black_user_title, nodes$name)-1

ColourScal  <- 'd3.scaleOrdinal() .range(["#FDE725FF","#B4DE2CFF","#6DCD59FF","#35B779FF","#1F9E89FF","#26828EFF","#31688EFF","#3E4A89FF","#482878FF","#440154FF"])'


p <- sankeyNetwork(Links = links, Nodes = nodes,
                     Source = "IDsource", Target = "IDtarget",
                     Value = "n", NodeID = "name", 
                     sinksRight=FALSE, colourScale=ColourScal, nodeWidth=40, fontSize=13, nodePadding=20)

p
```
Widać wyraźnie dominację meczy między graczami bez tytułów



Jak ma się czas trwania partii do jej rezultatu?
```{r}
data %>% 
  mutate(duration = duration_in_miliseconds / 1000) %>% 
  group_by(winner) %>% 
  summarise(mean_duration =  mean(duration)) %>% 
  ggplot(aes(x = fct_infreq(winner, mean_duration), y = mean_duration, fill = winner)) +
  geom_bar(stat = "identity")


important_statuses <- data %>% 
  count(status) %>%  filter(n > 1000)


data %>% 
  filter(status %in% important_statuses$status) %>% 
  ggplot(aes(x = winner, fill = status)) +
  geom_bar()
```
Oczywiście, dla remisów czas ten będzie dużo dłuższy, ponieważ do remisó dochodzi przy przekroczeniu czasu przez jednego gracza, po długiej końcówce, 


Czy partie mistrzów trwają dłużej?
```{r}

players_titles_top_10 <- data %>% 
  mutate(duration = duration_in_miliseconds / 1000) %>% 
  filter(speed == "bullet") %>% 
  group_by(players_white_user_title, players_black_user_title) %>% 
  summarise(n = n(),
            mean_duration = mean(duration)) %>% 
  arrange(desc(n)) %>% 
  head(n = 10)


players_titles_top_10$combined_titles <-  paste(players_titles_top_10$players_white_user_title, 
                                                    players_titles_top_10$players_black_user_title,
                                                    sep = "-")

players_titles_top_10 %>% 
  ggplot(aes(x = fct_infreq(combined_titles, mean_duration),
             y = mean_duration,
             fill = fct_infreq(combined_titles, mean_duration))) +
  geom_bar(stat = "identity") +
  theme(legend.position = "none")
```



Czas trwania partii a jej wynik?
```{r}
data %>% 
  mutate(duration = duration_in_miliseconds / 1000) %>% 
  filter(speed == "blitz") %>% 
  ggplot(aes(x = winner, y = duration, fill = winner)) +
  geom_boxplot()
```


Jak się ma ranking gracza do jego tytułu
```{r}
data %>% 
  filter(players_white_user_title %in% players_con$players_white_user_title & speed == "bullet") %>% 
  ggplot(aes(x = players_white_user_title, y = players_white_rating, fill = players_white_user_title)) +
  geom_boxplot()
```


Czy gry między graczami z dużą różnicą rankingu są sporo krótsze?
```{r}
data %>% 
  filter(speed == "bullet") %>% 
  mutate(duration = duration_in_miliseconds / 1000,
         ranking_diff = abs(players_white_rating - players_black_rating),
         combined_titles = paste(players_white_user_title, 
                                 players_black_user_title,
                                                    sep = "-")) %>% 
  filter(combined_titles %in% players_titles_top_10$combined_titles) %>% 
  ggplot(aes(x = duration, y = ranking_diff, color = combined_titles)) +
  geom_point()

# Do poprawienia
```

